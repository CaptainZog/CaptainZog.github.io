<html>
<head>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <style type="text/css">

        .sidebar {
            height: 100%;
            width: 200px;
            background-color: #fff;
            position: fixed !important;
            z-index: 1;
            overflow: auto
        }

        .navbar {
            border: 1px solid #ccc !important;
            border-radius: 4px
        }

        .navbutton {
            border: none;
            display: inline-block;
            padding: 8px 16px;
            vertical-align: middle;
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            background-color: inherit;
            text-align: center;
            cursor: pointer;
            white-space: normal
        }

            .navbutton:hover {
                color: #000 !important;
                background-color: #ccc !important
            }

        .navactive {
            color: #fff !important;
            background-color: #4CAF50 !important
        }

        rect {
            fill: lightblue;
            stroke: black;
        }

        .hidden {
            display: none;
        }

        .tooltip {
            position: absolute;
            width: 200px;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 100, 100, 0.4);
            pointer-events: none;
        }

            .tooltip p {
                margin: 0;
                font-family: sans-serif;
                font-size: 16px;
                line-height: 20px;
            }
    </style>
</head>
<body onload='init()'>
    <div class="sidebar w3-round" style="width:25%">
        <h2>Major US City Populations</h2>
        <div class="navbar">
            <a href="#" class="navbutton" onclick="return NavPrevScene();">&laquo;</a>
            <a id="Scene1" class="navbutton" onclick="return NavScene(1);">1</a>
            <a id="Scene2" class="navbutton" onclick="return NavScene(2);">2</a>
            <a id="Scene3" class="navbutton" onclick="return NavScene(3);">3</a>
            <a id="Scene4" class="navbutton" onclick="return NavScene(4);">4</a>
            <a href="#" class="navbutton" onclick="return NavNextScene();">&raquo;</a>
        </div>
        <br />
        <div style="padding:20px">
            <span id="SceneDescription">The US cities with the highest populations are shown.</span>
        </div>
    </div>
    <div style="margin-left:28%;">
        <div style="height:5%;font-size:24px;">Year: <span id="Year" style="font-weight:bold;color:darkblue;">2010</span></div>
        <div>
            <svg id="canvas"></svg>
        </div>
    </div>
    <div id="tooltip" class="tooltip hidden">
        <p><strong id="tooltipHeader">Tooltip Header</strong></p>
        <p><span id="tooltipText">Tooltip Text</span></p>
    </div>

    <script>
        // Globals
        var chartWidth = 800
        var chartHeight = 400;
        var maxPopulation = 9000000;
        var xScale = null
        var yScale = null;
        var lastSceneNumber = 0;
        var sceneNumber = 1;
        var showAnnotation1 = false
        var showAnnotation2 = false
        var paramDescription = "";
        var paramYear = 2010;
        var fullDataset = null;
        var sceneDataset = null;

        async function init() {
            fullDataset = await d3.csv("https://CaptainZog.github.io/USCities/USCityPopulations.csv");
            RefreshSceneDataset();
            InitChart()
            UpdateChartData();
            NavScene(1);
        }

        annotation1 = [
            {
                note: {
                    label: "Phoenix jumps into 5th place",
                    title: "Sunbelt Growth"
                },
                x: 400,
                y: 358,
                dy: -100,
                dx: 20
            }
        ]

        annotation2 = [
            {
                note: {
                    label: "Phoenix holds onto 5th place more comfortabley",
                    title: "Sunbelt Growth"
                },
                x: 400,
                y: 358,
                dy: -100,
                dx: 20
            }
        ]

        // Add annotation to the chart
        const makeAnnotation1 = d3.annotation().annotations(annotation1)
        const makeAnnotation2 = d3.annotation().annotations(annotation2)

        function RefreshSceneDataset() {
            sceneDataset = fullDataset.filter(a => a.Year == paramYear && a.Population >= 1000000).sort(function (a, b) {
                return b.Population - a.Population;
            });
        }
        
        function InitChart() {
            var border = 30;
            var tooltip = d3.select("#tooltip");

            xScale = d3.scaleBand().domain(sceneDataset.map(d => d.City)).range([0, chartWidth]).padding(0.05);
            yScale = d3.scaleLinear().domain([0, maxPopulation]).range([chartHeight, 0]);

            d3.select("#canvas").select("#datarects").remove();
            d3.select("#canvas").select("#xAxis").remove();
            d3.select("#canvas").select("#yAxis").remove();

            d3.select("#canvas")
                .attr("width", chartWidth + border * 2)
                .attr("height", chartHeight + border * 2)
                .append("g").attr("id", "datarects").attr("transform", "translate(" + border + "," + border + ")")
                .selectAll("rect")
                .data(sceneDataset)
                .enter()
                .append("rect")
                .attr("x", (d, i) => xScale(d.City))
                .attr("y", function (d, i) { return yScale(0); })
                .attr("width", d => xScale.bandwidth())
                .attr("height", function (d) { return chartHeight - yScale(0); })
                .on("mouseover", function (d, i) {
                    tooltip.classed("hidden", false)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px")
                        .select("#tooltipHeader").text(d.City);
                    tooltip.select("#tooltipText").html("State: " + d.State + "<br />Year: " + d.Year + "<br />Population: " + parseInt(d.Population).toLocaleString('en-US'));
                })
                .on("mouseout", function () { tooltip.classed("hidden", true); })

            d3.select("#canvas")
                .append("g").attr("id", "yAxis").attr("transform", "translate(" + border + "," + border + ")")
                .call(d3.axisLeft(yScale).tickFormat(d3.format("~s")));

            d3.select("#canvas")
                .append("g").attr("id", "xAxis").attr("transform", "translate(" + border + "," + (chartHeight + border) + ")")
                .call(d3.axisBottom(xScale));
        }

        function UpdateChartData() {
            xScale = d3.scaleBand().domain(sceneDataset.map(d => d.City)).range([0, chartWidth]).padding(0.05);
            
            d3.select("#canvas").select("#xAxis")
                .transition().duration(500)
                .call(d3.axisBottom(xScale));
                
            var bars = d3.select("#canvas").selectAll("rect")
                .data(sceneDataset);
            bars.transition().duration(500)
                .attr("y", function (d, i) { return yScale(d.Population); })
                .attr("height", function (d) { return chartHeight - yScale(d.Population); })

            if (showAnnotation1) {
                d3.select("#canvas")
                    .append("g").attr("id", "annotation1")
                    .call(makeAnnotation1)
                d3.select("#annotation1").classed("hidden", false);
            }
            else {
                d3.select("#annotation1").classed("hidden", true);
            }

            if (showAnnotation2) {
                d3.select("#canvas")
                    .append("g").attr("id", "annotation2")
                    .call(makeAnnotation2)
                d3.select("#annotation2").classed("hidden", false);
            }
            else {
                d3.select("#annotation2").classed("hidden", true);
            }
        }

        function NavPrevScene() {
            if (sceneNumber > 1)
                NavScene(sceneNumber - 1);
        }

        function NavScene(newSceneNumber) {
            if (newSceneNumber == 1) {
                SetParamDescription("In the year 2010... something happened...")
                SetParamYear(2010);
                showAnnotation1 = false;
                showAnnotation2 = false;
            }
            else if (newSceneNumber == 2) {
                SetParamYear(2012);
                SetParamDescription("In the year 2012... then something else thing...")
                showAnnotation1 = false;
                showAnnotation2 = false;
            }
            else if (newSceneNumber == 3) {
                SetParamYear(2016);
                SetParamDescription("In the year 2016... then nothing happened...")
                showAnnotation1 = true;
                showAnnotation2 = false;
            }
            else if (newSceneNumber == 4) {
                SetParamYear(2019);
                SetParamDescription("In the year 2019... something else happened...")
                showAnnotation1 = false;
                showAnnotation2 = true;
            }

            d3.select("#Scene" + sceneNumber).classed("navactive", false);
            sceneNumber = newSceneNumber;
            d3.select("#Scene" + sceneNumber).classed("navactive", true);
            
            RefreshSceneDataset();
            UpdateChartData();
        }

        function NavNextScene() {
            if (sceneNumber < 4)
                NavScene(sceneNumber + 1);
        }

        function SetParamDescription(description) {
            var descriptionElement = d3.select("#SceneDescription");
            descriptionElement.text(description);
            paramDescription = description;
        }

        function SetParamYear(year) {
            var yearElement = d3.select("#Year");
            yearElement.text(year);
            paramYear = year;
        }

    </script>
</body>
</html>
